<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Feature Requests</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.3/css/bootstrap.min.css" integrity="sha384-Zug+QiDoJOrZ5t4lssLdxGhVrurbmBWopoEl+M6BdEfwnCJZtKxi1KgxUyJq13dy"
    crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
    crossorigin="anonymous">
  <link href="/pikaday.css" rel="stylesheet">
  <style>
    .navbar {
      margin-bottom: 0;
    }

    .jumbotron {
      padding-top: 6rem;
      padding-bottom: 6rem;
      margin-bottom: 0;
      background-color: #fff;
    }

    .jumbotron p:last-child {
      margin-bottom: 0;
    }

    .jumbotron-heading {
      font-weight: 300;
    }

    .jumbotron .container {
      max-width: 40rem;
    }

    .hide {
      display: none;
    }

    .wrapper {
      min-height: 25rem;
      padding-top: 3rem;
      padding-bottom: 3rem;
      background-color: #f7f7f7;
    }

    footer {
      padding-top: 3rem;
      padding-bottom: 3rem;
    }

    footer p {
      margin-bottom: .25rem;
    }

    .show {
      display: block;
    }

    select {
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .form-group select {
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      height: auto;
    }

    .form-group select.form-control+.btn-group-vertical>.btn:first-child {
      border-top-right-radius: .25rem;
      border-top-left-radius: 0;
    }

    .form-group select.form-control+.btn-group-vertical>.btn:last-child {
      border-bottom-right-radius: .25rem;
      border-bottom-left-radius: 0;
    }

    #feature-list tbody {
      counter-reset: line;
    }

    #feature-list tbody tr {
      counter-increment: line;
    }

    #feature-list tbody tr td:first-child::before {
      content: counter(line);
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <div class="navbar navbar-dark bg-dark">
    <div class="container d-flex justify-content-between">
      <a href="#" class="navbar-brand">Feature Request</a>
    </div>
  </div>
  <section class="jumbotron text-center">
    <div class="container">
      <h1 class="jumbotron-heading">Feature Request App</h1>
      <p class="lead text-muted">
        Add a feature request. You can also add missing clients or product areas.
      </p>
      <p>
        <a href="#feature-modal" role="button" id="addButton" class="btn btn-lg btn-success" data-toggle="modal">Add
          Feature</a>
      </p>
    </div>
  </section>
  <div class="wrapper text-muted">
    <div class="container" id="feature-list">
      <h2 class="text-center">Feature List</h2>
      <div class="row">
        <div class="col-md-3 offset-md-9">
          <div class="input-group input-group-sm mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text">Filter:</span>
            </div>
            <input type="text" id="filter" aria-label="filter" name="filter" class="form-control" title="Filter by title, description, client or feature area">
          </div>
        </div>
      </div>
      <div class="row">
        <style scoped="" id="filter-css">

        </style>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>#</th>
              <th>Title</th>
              <th>Description</th>
              <th>Target Date</th>
              <th>Priority</th>
              <th>Client Name</th>
              <th>Feature Area</th>
              <th>Complete</th>
              <th>Edit</th>
            </tr>
          </thead>
          <tbody id="feature-list-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div>

  </div>
  <footer class="text-muted">
    <div class="container">
      <p class="float-right">
        <a href="#">Back to top</a>
      </p>
      <p>&copy; Educatio Inc.</p>
    </div>
  </footer>

  <div id="feature-modal" class="modal">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Feature</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="feature-form" action="/features/" method="POST" data-default-action="/features/"
            data-default-method="POST">
            <div class="form-group">
              <label class="control-label" for="title">Title</label>
              <input type="text" id="title" name="title" placeholder="" class="form-control" required>
            </div>

            <div class="form-group">
              <label class="control-label" for="description">Description</label>
              <textarea id="description" name="description" class="form-control" required></textarea>
              <small class="form-text text-muted">A long description of the feature request.</small>
            </div>

            <div class="form-group">

            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="client">Client</label>
              <select size="1" id="client" name="client" pattern="^\d+$" class="form-control col-sm-4" required>
              </select>
              <div class="btn-group-vertical">
                <a href="#client-modal" role="button" class="btn btn-secondary btn-sm" data-toggle="modal">
                  <span class="fa fa-file-o" aria-hidden="true"></span>
                </a>
                <button id="edit-client" type="button" class="btn btn-secondary btn-sm" title="edit">
                  <span class="fa fa-pencil-square-o" aria-hidden="true"></span>
                </button>
              </div>
              <label class="col-sm-2 col-form-label" for="priority">Priority</label>
              <input type="number" min="1" max="10" id="priority" name="priority" placeholder="" class="form-control col-sm-3"
                required>
            </div>

            <div class="form-group row">
              <label class="col-sm-2 col-form-label" for="category">Feature Area</label>
              <select size="1" id="category" name="category" pattern="^\d+$" class="form-control col-sm-4" required>
              </select>
              <div class="btn-group-vertical">
                <a href="#category-modal" role="button" class="btn btn-secondary btn-sm" data-toggle="modal">
                  <span class="fa fa-file-o" aria-hidden="true"></span>
                </a>
                <button id="edit-category" type="button" class="btn btn-secondary btn-sm" title="edit">
                  <span class="fa fa-pencil-square-o" aria-hidden="true"></span>
                </button>
              </div>
              <label class="col-sm-2 col-form-label" for="targetdate">Target Date</label>
              <input type="text" id="target_date" name="target_date" placeholder="YYYY-MM-DD" pattern="^\d{4}-\d{1,2}-\d{1,2}$"
                class="form-control col-sm-3" required>
            </div>
            <div class="custom-control custom-checkbox">
              <input type="checkbox" name="complete" class="custom-control-input" id="custom-check">
              <label class="custom-control-label" for="custom-check">Completed</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="save-feature" form="feature-form">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="client-modal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Client</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <form id="client-form" action="/clients/" method="POST" data-default-action="/clients/" data-default-method="POST">
              <label for="client-name">Client Name</label>
              <input type="text" class="form-control" id="client-name" name="name" required pattern="(?!^ +$)^.+$">
            </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="client-form">Save</button>
        </div>
      </div>
    </div>
  </div>

  <div id="category-modal" class="modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Category</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <form id="category-form" action="/categories/" method="POST" data-default-action="/categories/"
              data-default-method="POST">
              <label for="category-name">Product Area</label>
              <input type="text" class="form-control" id="category-name" name="name" required pattern="(?!^ +$)^.+$">
            </form>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" form="category-form">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/modal.js"></script>
  <script src="/form.js"></script>
  <script src="/restclient.js"></script>
  <script>
    let featureForm = new Form("feature-form");
    let clientForm = new Form("client-form");
    let categoryForm = new Form("category-form");

    let featureModal = new Modal("feature-modal");
    let clientModal = new Modal("client-modal");
    let categoryModal = new Modal("category-modal");
  </script>
  <script>
    let featureTemplate = featureModel => {
      let tr = document.createElement('tr');
      tr.dataset.id = featureModel.id;
      tr.dataset.title = featureModel.title;
      let clientName = clientIdNameMap[featureModel.client] || '';
      let categoryName =  categoryIdNameMap[featureModel.category] || '';
      tr.dataset.categoryId = featureModel.category;
      tr.dataset.clientId = featureModel.client;
      tr.dataset.category = clientName;
      tr.dataset.client = categoryName;
      tr.dataset.dateCreated = featureModel.date_created;
      tr.dataset.priority = featureModel.priority;
      tr.innerHTML =
        `<td></td>
        <td>${featureModel.title}</td>
        <td>${featureModel.description}</td>
        <td>${featureModel.target_date.slice(0, 10)}</td>
        <td>${featureModel.priority}</td>
        <td data-client-id="${featureModel.client}">${clientName}</td>
        <td data-category-id="${featureModel.category}">${categoryName}</td>
        <td>${featureModel.complete}</td>
        <td>
          <button data-id="${featureModel.id}" type="button" class="btn btn-secondary btn-sm" title="edit">
            <span class="fa fa-pencil-square-o" aria-hidden="true"></span>
          </button>
          <button data-id="${featureModel.id}" type="button" class="btn btn-danger btn-sm" title="delete">
            <span class="fa fa-trash-o" aria-hidden="true"></span>
          </button>
        </td>`;
      return tr;
    }
    let optionTemplate = optionModel => {
      let option = document.createElement("option");
      option.value = optionModel.id;
      option.textContent = optionModel.name;
      return option;
    }
    const featureSorter = (left, right) => {
      let diff = left.dataset.clientId - right.dataset.clientId;
      if (diff != 0)
        return diff;
      diff = right.dataset.priority - left.dataset.priority;
      if (diff != 0)
        return diff;
      return (new Date(right.dataset.dateCreated) - (new Date(left.dataset.dateCreated)));
    };
  </script>
  <script>
    let filterCSS = document.getElementById("filter-css");

    function applyFilter(filter) {
      filterCSS.textContent = filter ?
        `tbody tr{display:none}
      tbody tr[data-title*="${filter}" i],tbody tr[data-client*="${filter}" i],tbody tr[data-category*="${filter}" i]{display:table-row}` :
        '';
    }
    let inputFilter = document.getElementById("filter");
    inputFilter.addEventListener("input", () => {
      applyFilter(inputFilter.value);
    });
    applyFilter(inputFilter.value);
  </script>
  <script>
    let features = new RestClient("features");
    let clients = new RestClient("clients");
    let categories = new RestClient("categories");
    let clientIdNameMap = {};
    let categoryIdNameMap = {};

    let featureListTbody = document.getElementById("feature-list-tbody");

    function sortFeatures() {
      [...featureListTbody.children].sort(featureSorter).map(node => featureListTbody.appendChild(node));
    }

    featureForm.onPost = json => {
      let template = featureTemplate(json);
      featureListTbody.appendChild(template);
      sortFeatures();
      featureModal.hide();
    };

    clientForm.onPost = json => {
      clientIdNameMap[json.id] = json.name;
      let template = optionTemplate(json);
      clientSelect.appendChild(template);
      clientModal.hide();
    };

    categoryForm.onPost = json => {
      categoryIdNameMap[json.id] = json.name;
      let template = optionTemplate(json);
      categorySelect.appendChild(template);
      categoryModal.hide();
    };

    features.getAll()
      .then(json => {
        for (let item of json) {
          let template = featureTemplate(item);
          featureListTbody.appendChild(template);
        }
      });

    let deleteHandler = e => {
      let button = e.target.closest('button[title="delete"]');
      if (!button) {
        return;
      }
      let yes = confirm("Are you sure you want to delete the item?");
      if (yes) {
        let tr = e.target.closest('tr');
        let itemId = button.dataset.id;
        features.delete(itemId).then(json => {
          tr.remove();
        });
      }
    }
    let editHandler = e => {
      let button = e.target.closest('button[title="edit"]');
      if (!button) {
        return;
      }
      let tr = e.target.closest('tr');
      let itemId = button.dataset.id;
      features.get(itemId).then(feature => {
        featureForm.fromObj(feature);
        let target_date = value => {
          let date = new Date(value);
          if (!isNaN(date.getTime())) {
            return `${date.getFullYear()}-${(date.getMonth()+1)}-${date.getDate()}`;
          }
        }
        featureForm.setter("target_date", target_date(feature.target_date))
        featureForm.form.method = "PUT";
        featureForm.form.action = `/features/${itemId}`;
        featureForm.onPut = json => {
          let newTr = featureTemplate(json);
          tr.replaceWith(newTr);
          sortFeatures();
          featureModal.hide();
        }
        featureModal.show();
      });

    };

    let editCategoryButton = document.getElementById("edit-category");
    let editClientButton = document.getElementById("edit-client");

    editCategoryButton.addEventListener("click", e => {
      let option = categorySelect.options[categorySelect.selectedIndex];
      let categoryId = option.value;
      categories.get(categoryId).then(category =>{
        categoryForm.fromObj(category);
        categoryForm.form.method = "PUT";
        categoryForm.form.action = `/categories/${categoryId}`;
        categoryForm.onPut = json =>{
          let newOption = optionTemplate(json);
          categoryIdNameMap[json.id] = json.name;
          option.replaceWith(newOption);
          newOption.selected = true;
          populatePlacholders(categoryIdNameMap, 'category');
          categoryModal.hide();
        };
        categoryModal.show();
      });
    });

    editClientButton.addEventListener("click", e => {
      let option = clientSelect.options[clientSelect.selectedIndex];
      let clientId = option.value;
      clients.get(clientId).then(client =>{
        clientForm.fromObj(client);
        clientForm.form.method = "PUT";
        clientForm.form.action = `/clients/${clientId}`;
        clientForm.onPut = json =>{
          let newOption = optionTemplate(json);
          clientIdNameMap[json.id] = json.name;
          option.replaceWith(newOption);
          newOption.selected = true;
          populatePlacholders(clientIdNameMap, 'client');
          clientModal.hide();
        };
        clientModal.show();
      });
    });

    featureListTbody.addEventListener("click", editHandler);
    featureListTbody.addEventListener("click", deleteHandler);

    let clientSelect = document.getElementById("client");
    let categorySelect = document.getElementById("category");

    function populatePlacholders(idNameMap, name) {
      let placeholders = document.querySelectorAll(`[data-${name}-id]`);
      for (let placeholder of placeholders) {
        if (placeholder.hasAttribute(`data-${name}`)) {
          placeholder.dataset[`${name}`] = idNameMap[placeholder.dataset[`${name}Id`] | 0];
        } else {
          placeholder.textContent = idNameMap[placeholder.dataset[`${name}Id`] | 0];
        }
      }
    }

    clients.getAll()
      .then(json => {
        for (let item of json) {
          let option = optionTemplate(item);
          clientSelect.appendChild(option);
          clientIdNameMap[item.id] = item.name;
        }
        populatePlacholders(clientIdNameMap, 'client');
      });

    categories.getAll()
      .then(json => {
        for (let item of json) {
          let option = optionTemplate(item);
          categorySelect.appendChild(option);
          categoryIdNameMap[item.id] = item.name;
        }
        populatePlacholders(categoryIdNameMap, "category");
      });

    featureModal.onHide = () => {
      featureForm.reset();
    };

    clientModal.onHide = () => {
      clientForm.reset();
    };

    categoryModal.onHide = () => {
      categoryForm.reset();
    };
  </script>
  <script src="/pikaday.js"></script>
  <script>
    var picker = new Pikaday({
      field: document.getElementById('target_date'),
      minDate: new Date(),
      format: 'YYYY-MM-DD',
      toString(date, format) {
        const day = (date.getDate() + "").padStart(2, "0");
        const month = (date.getMonth() + 1 + "").padStart(2, "0");
        const year = date.getFullYear();
        return `${year}-${month}-${day}`;
      },
      parse(dateString, format) {
        const parts = dateString.split('-');
        const day = parts[2] | 0;
        const month = (parts[1] | 0) - 1;
        const year = parts[0] | 0;
        return new Date(year, month, day);
      }
    });
  </script>
</body>

</html>